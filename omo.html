<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chapter Submissions</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      margin-top: 40px;
    }
    h1 {
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Chapter Submissions</h1>
    <table class="table table-bordered" id="chapterTable">
      <thead class="thead-dark">
        <tr>
          <th>Chapter Name</th>
          <th>File</th>
          <th>Upload Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Chapter submission rows will be injected here -->
      </tbody>
    </table>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Replace with the actual group ID from your application state
      const groupId = "67d3235f8cce7db3ff328807"; 
      const token = localStorage.getItem("token"); // if authentication is needed
      
      try {
        // Use the updated route that accepts groupId as a route parameter
        const response = await fetch(`http://localhost:5000/api/chapterSubmissions/group/${encodeURIComponent(groupId)}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          }
        });
        if (!response.ok) {
          console.error("Error fetching chapter submissions");
          return;
        }
        const submissions = await response.json();
        console.log("Submissions:", submissions);
        populateTable(submissions);
      } catch (error) {
        console.error("Error fetching chapter submissions:", error);
      }
    });
    
    // Populate the table with fetched chapter submissions
    function populateTable(submissions) {
      const tbody = document.querySelector("#chapterTable tbody");
      tbody.innerHTML = "";
      submissions.forEach((submission) => {
        const tr = document.createElement("tr");
        
        // Chapter Name
        const tdChapter = document.createElement("td");
        tdChapter.textContent = submission.chapterName || "N/A";
        tr.appendChild(tdChapter);
        
        // File: Instead of using fileUrl, check if fileId exists.
        const tdFile = document.createElement("td");
        tdFile.textContent = submission.fileId ? "File available" : "N/A";
        tr.appendChild(tdFile);
        
        // Upload Date (using dateSubmitted field if available)
        const tdDate = document.createElement("td");
        const date = submission.dateSubmitted ? new Date(submission.dateSubmitted) : new Date();
        tdDate.textContent = date.toLocaleString();
        tr.appendChild(tdDate);
        
        // Actions: Download button
        const tdActions = document.createElement("td");
        const downloadBtn = document.createElement("button");
        downloadBtn.className = "btn btn-primary btn-sm";
        downloadBtn.textContent = "Download";
        downloadBtn.addEventListener("click", () => {
          // Open the download endpoint in a new tab using the submission _id
          window.open(`http://localhost:5000/api/chapterSubmissions/download/${submission._id}`, "_blank");
        });
        tdActions.appendChild(downloadBtn);
        tr.appendChild(tdActions);
        
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
